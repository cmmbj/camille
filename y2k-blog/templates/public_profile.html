{% extends 'base.html' %}

{% block title %}{{ user['display_name'] }} - Tessia's Space{% endblock %}

{% block content %}
<div class="split-layout">
    <!-- Left Column: Profile Info -->
    <div class="left-col">
        <div class="myspace-box profile-box" style="text-align: center;">
            <h2 class="myspace-title">âœ¨ {{ user['display_name'] }}'s Profile âœ¨</h2>
            <i>@{{ user['username'] }}</i>

            <!-- Profile Picture and Status -->
            <div style="position: relative; display: inline-block; margin-top: 15px;">
                {% if user['status_note'] %}
                <div class="status-bubble-container">
                    <div class="status-bubble">{{ user['status_note'] }}</div>
                </div>
                {% endif %}
                <img src="{{ user['profile_picture'] }}" alt="Profile Picture" class="avatar"
                    style="width: 150px; height: 150px; object-fit: cover; border-radius: 10px; border: 2px solid var(--border-color);">
                <div style="margin-top: 10px;">
                    <span class="status-indicator" title="{{ user['status']['label'] }}">{{ user['status']['color']
                        }}</span>
                    <strong>{{ user['status']['label'] }}</strong>
                </div>
            </div>

            <!-- Bio Section -->
            <div class="bio-section"
                style="margin-top: 20px; text-align: left; background: rgba(255,255,255,0.4); padding: 10px; border-radius: 5px;">
                <h4 style="margin-top: 0; color: var(--accent-color);">About me:</h4>
                <p style="white-space: pre-line; margin: 0;">{{ user['bio'] }}</p>
            </div>

            <!-- Interaction Buttons -->
            {% if session.get('user_id') and session['user_id'] != user['id'] %}
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border-color);">
                {% if relationship == 'none' %}
                <form action="{{ url_for('add_friend', target_id=user['id']) }}" method="POST" style="display:inline;">
                    <button type="submit" class="cute-btn">ğŸ’– Ajouter en ami</button>
                </form>
                {% elif relationship == 'request_sent' %}
                <button class="cute-btn" disabled style="opacity: 0.7;">â³ Demande envoyÃ©e</button>
                {% elif relationship == 'request_received' %}
                <form action="{{ url_for('accept_friend', target_id=user['id']) }}" method="POST"
                    style="display:inline;">
                    <button type="submit" class="action-btn liked">âœ¨ Accepter</button>
                </form>
                {% elif relationship == 'friends' %}
                <button class="cute-btn" disabled style="background-color: #8fbc8f;">ğŸ‘¯â€â™€ï¸ Amis !</button>
                <form action="{{ url_for('remove_friend', target_id=user['id']) }}" method="POST"
                    style="display:inline;">
                    <button type="submit" class="action-btn" onclick="return confirm('Retirer des amis ?')">ğŸ’”
                        Retirer</button>
                </form>
                <br><br>
                <a href="{{ url_for('messages') }}" class="cute-btn" style="text-decoration: none;">ğŸ’Œ Envoyer un DM</a>
                {% elif relationship == 'blocked' %}
                <form action="{{ url_for('unblock_user', target_id=user['id']) }}" method="POST"
                    style="display:inline;">
                    <button type="submit" class="action-btn">ğŸ”“ DÃ©bloquer</button>
                </form>
                {% endif %}

                {% if relationship != 'blocked' %}
                <br><br>
                <form action="{{ url_for('block_user', target_id=user['id']) }}" method="POST" style="display:inline;">
                    <button type="submit" class="action-btn" style="color: #c0392b; border-color: #c0392b;"
                        onclick="return confirm('Bloquer cet utilisateur ? Tu ne verras plus ses posts.')">ğŸš«
                        Bloquer</button>
                </form>
                {% endif %}
            </div>
            {% endif %}

            <!-- Music embed -->
            {% if user['music_link'] %}
            <div class="music-player" style="margin-top: 20px;">
                <h4 style="margin-bottom: 5px; color: var(--accent-color);">ğŸµ Now playing ğŸµ</h4>
                {% if 'spotify' in user['music_link'] %}
                <iframe style="border-radius:12px" src="{{ user['music_link'] }}" width="100%" height="152"
                    frameBorder="0" allowfullscreen=""
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    loading="lazy"></iframe>
                {% else %}
                <a href="{{ user['music_link'] }}" target="_blank" class="cute-btn"
                    style="text-decoration: none;">Listen to my track! ğŸ§</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Right Column: User's Posts -->
    <div class="right-col">
        <div class="myspace-box feed-box">
            <h2>ğŸ€ {{ user['display_name'] }}'s Posts ğŸ€</h2>

            {% if not posts %}
            <p style="text-align: center; font-style: italic;">No posts yet! ğŸŒ¸</p>
            {% else %}
            {% for post in posts %}
            <div class="post" id="post-{{ post['id'] }}">
                <div class="post-header">
                    <div class="post-author" style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                        <img src="{{ post['profile_picture'] }}" alt="avatar"
                            style="width: 30px; height: 30px; object-fit: cover;">
                        {{ post['display_name'] }}
                        <span style="font-weight: normal; font-size: 0.8rem;">(@{{ post['username'] }})</span>

                        {% if session.get('user_id') and session['user_id'] != post['author_id'] %}
                        <span style="display: flex; gap: 5px; align-items: center; margin-left: auto;">
                            <a href="{{ url_for('messages', chat_username=post['username']) }}"
                                class="social-btn msg-btn" title="Envoyer un message">
                                <svg viewBox="0 0 24 24">
                                    <path
                                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
                                </svg>
                            </a>
                            <form action="{{ url_for('add_friend', target_id=post['author_id']) }}" method="POST"
                                style="margin: 0;">
                                <button type="submit" class="social-btn add-btn" title="Ajouter en ami">
                                    <svg viewBox="0 0 24 24">
                                        <path
                                            d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                    </svg>
                                </button>
                            </form>
                            <form action="{{ url_for('block_user', target_id=post['author_id']) }}" method="POST"
                                style="margin: 0;">
                                <button type="submit" class="social-btn block-btn" title="Bloquer"
                                    onclick="return confirm('Bloquer cet utilisateur ?');">
                                    <svg viewBox="0 0 24 24">
                                        <path
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z" />
                                    </svg>
                                </button>
                            </form>
                        </span>
                        {% endif %}
                    </div>
                    <div>
                        <span class="badge"
                            style="background: var(--secondary-bg); color: #fff; padding: 2px 5px; border-radius: 5px; font-size: 0.8rem;">
                            {% if post['post_type'] == 'message' %}ğŸ’¬ Message
                            {% elif post['post_type'] == 'photo' %}ğŸ“¸ Photo
                            {% elif post['post_type'] == 'video' %}ğŸ¥ VidÃ©o
                            {% elif post['post_type'] == 'story' %}â± Story
                            {% else %}ğŸ’¬ Message{% endif %}
                        </span>
                        {% if post['visibility'] == 'friends' %}
                        <span class="badge"
                            style="background: #8fbc8f; color: #fff; padding: 2px 5px; border-radius: 5px; font-size: 0.8rem; margin-left: 5px;"
                            title="Amis uniquement">ğŸ‘¯â€â™€ï¸ Amis</span>
                        {% endif %}
                        <span class="post-date" style="margin-left: 10px;">{{ post['created_at'] | timeago }}</span>
                    </div>
                </div>

                <div class="post-content">
                    {% if post['image_url'] %}
                    <div style="margin-bottom: 20px; text-align: center;">
                        <img src="{{ post['image_url'] }}" alt="Post image"
                            style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 2px solid var(--border-color); object-fit: contain;">
                    </div>
                    {% endif %}
                    {{ post['content'] | safe }}
                </div>

                {% if session.get('role') == 'admin' %}
                <div
                    style="margin-top: 10px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <form action="{{ url_for('delete_post', post_id=post['id']) }}" method="POST"
                        style="display:inline;">
                        <button type="submit" class="social-btn delete-btn"
                            onclick="return confirm('Supprimer ce post ?');">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                            </svg> Delete Post
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}