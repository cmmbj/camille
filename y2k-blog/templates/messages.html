{% extends 'base.html' %}

{% block title %}Messages - Tessia's Space{% endblock %}

{% block content %}
<div class="myspace-box profile-box" style="padding: 0; overflow: hidden; display: flex; height: 75vh;">

    <!-- Left Sidebar: Friends List -->
    <div
        style="flex: 1; border-right: 2px dashed var(--border-color); display: flex; flex-direction: column; background: var(--container-bg);">
        <h3
            style="padding: 15px; margin: 0; border-bottom: 2px dashed var(--border-color); text-align: center; color: var(--accent-color);">
            üí¨ Conversations</h3>

        <div style="overflow-y: auto; flex: 1;">
            {% if not friends %}
            <p style="padding: 20px; text-align: center; color: #888; font-style: italic;">Tu n'as pas encore d'amis √†
                contacter.</p>
            {% else %}
            {% for friend in friends %}
            <a href="{{ url_for('messages', chat_username=friend['username']) }}"
                style="display: flex; align-items: center; padding: 15px; border-bottom: 1px dotted var(--border-color); text-decoration: none; color: inherit; background: {% if active_chat_user and active_chat_user['username'] == friend['username'] %}var(--secondary-bg){% else %}transparent{% endif %}; transition: background 0.2s;">

                <div style="position: relative;">
                    <img src="{{ friend['profile_picture'] }}" alt="avatar"
                        style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color);">
                    <span style="position: absolute; bottom: 0; right: 0; font-size: 0.8rem;"
                        title="{{ friend['status']['label'] }}">{{ friend['status']['color'] }}</span>
                </div>

                <div style="margin-left: 15px; overflow: hidden;">
                    <div
                        style="font-weight: bold; color: {% if active_chat_user and active_chat_user['username'] == friend['username'] %}#fff{% else %}var(--accent-color){% endif %};">
                        {{ friend['display_name'] }}</div>
                    <div
                        style="font-size: 0.85rem; color: {% if active_chat_user and active_chat_user['username'] == friend['username'] %}#fff{% else %}#888{% endif %}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {% if friend['last_message'] %}
                        {{ friend['last_message'] | striptags | truncate(30) }}
                        {% else %}
                        <i>Commencer √† discuter</i>
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Right Context: Chat Window -->
    <div style="flex: 2; display: flex; flex-direction: column; background: #fff;">
        {% if not active_chat_user %}
        <div
            style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; background: var(--container-bg);">
            <div style="font-size: 4rem; margin-bottom: 10px;">üíå</div>
            <h3>Tes messages</h3>
            <p>S√©lectionne un ami pour discuter.</p>
        </div>
        {% else %}

        <!-- Chat Header -->
        <div
            style="padding: 15px; border-bottom: 2px dashed var(--border-color); display: flex; align-items: center; justify-content: space-between; background: var(--secondary-bg); color: #fff;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="{{ active_chat_user['profile_picture'] }}" alt="avatar"
                    style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fff;">
                <div>
                    <a href="{{ url_for('public_profile', username=active_chat_user['username']) }}"
                        style="color: #fff; font-weight: bold; text-decoration: none; font-size: 1.2rem;">{{
                        active_chat_user['display_name'] }}</a>
                    <div style="font-size: 0.8rem; opacity: 0.9;">{{ active_chat_user['status']['label'] }} {{
                        active_chat_user['status']['color'] }}</div>
                </div>
            </div>

            <!-- Search and Settings -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <form method="GET" action="{{ url_for('messages', chat_username=active_chat_user['username']) }}"
                    style="display: flex;">
                    <input type="text" name="q" placeholder="Rechercher..." value="{{ search_query }}"
                        style="padding: 5px 10px; border-radius: 15px; border: 1px solid var(--border-color); font-size: 0.8rem;">
                    <button type="submit"
                        style="background: none; border: none; cursor: pointer; color: #fff;">üîç</button>
                    {% if search_query %}
                    <a href="{{ url_for('messages', chat_username=active_chat_user['username']) }}"
                        style="color: #fff; text-decoration: none; font-size: 0.8rem; margin-left: 5px; line-height: 2;">‚ùå</a>
                    {% endif %}
                </form>

                <button onclick="document.getElementById('settings-modal').style.display='flex'"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #fff;"
                    title="Param√®tres de discussion">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Chat Settings Modal -->
        <div id="settings-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div class="myspace-box profile-box" style="width: 400px; max-width: 90%;">
                <h3
                    style="margin-top: 0; border-bottom: 2px dashed var(--border-color); padding-bottom: 10px; display: flex; justify-content: space-between;">
                    Param√®tres de discussion
                    <button type="button" onclick="document.getElementById('settings-modal').style.display='none'"
                        style="background: none; border: none; cursor: pointer;">‚ùå</button>
                </h3>
                <form method="POST"
                    action="{{ url_for('update_conversation_settings', chat_username=active_chat_user['username']) }}">
                    <div class="form-group">
                        <label for="nickname">Surnom pour {{ active_chat_user['username'] }}</label>
                        <input type="text" name="nickname" id="nickname" value="{{ my_settings.get('nickname', '') }}"
                            placeholder="Laisse vide pour afficher son vrai nom">
                    </div>

                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="show_read_receipts" id="show_read_receipts" value="1" {% if
                            my_settings.get('show_read_receipts', 1) %}checked{% endif %}>
                        <label for="show_read_receipts" style="margin: 0;">Envoyer des confirmations de lecture
                            (Vu)</label>
                    </div>

                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="ephemeral_mode" id="ephemeral_mode" value="1" {% if
                            my_settings.get('ephemeral_mode', 0) %}checked{% endif %}>
                        <label for="ephemeral_mode" style="margin: 0;">Mode √âph√©m√®re (effacer dans 24h)</label>
                    </div>

                    <button type="submit" class="cute-btn" style="width: 100%; margin-top: 15px;">Enregistrer
                        üíñ</button>
                </form>
            </div>
        </div>

        <!-- Chat Messages History -->
        <div id="chat-history"
            style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px;">
            {% if not messages %}
            <p style="text-align: center; color: #888; font-style: italic; margin-top: auto; margin-bottom: auto;">C'est
                le d√©but de votre histoire avec {{ active_chat_user['display_name'] }} ‚ú®</p>
            {% else %}
            {% for msg in messages %}
            {% if msg['sender_id'] == session['user_id'] %}
            <!-- My Message (Right) -->
            <div style="align-self: flex-end; max-width: 70%;">
                <div
                    style="background: var(--accent-color); color: #fff; padding: 10px 15px; border-radius: 15px 15px 0 15px; box-shadow: 0px 2px 5px rgba(0,0,0,0.1);">
                    {{ msg['content'] | safe }}
                </div>
                <div style="font-size: 0.7rem; color: #aaa; text-align: right; margin-top: 5px;">{{ msg['created_at'] |
                    timeago }}
                    {% if msg.get('show_vu') %}
                    <span style="margin-left: 5px; color: var(--accent-color); font-weight: bold;"
                        title="Vu par {{ active_chat_user['display_name'] }}">‚úì Vu</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <!-- Their Message (Left) -->
            <div style="align-self: flex-start; max-width: 70%; display: flex; gap: 10px;">
                <img src="{{ msg['sender_pfp'] }}"
                    style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; align-self: flex-end;">
                <div>
                    <div
                        style="background: #f0f0f0; color: var(--text-color); padding: 10px 15px; border-radius: 15px 15px 15px 0; box-shadow: 0px 2px 5px rgba(0,0,0,0.05);">
                        {{ msg['content'] | safe }}
                    </div>
                    <div style="font-size: 0.7rem; color: #aaa; margin-top: 5px;">{{ msg['created_at'] | timeago }}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}
        </div>

        <!-- Chat Input Form -->
        <div style="padding: 15px; border-top: 2px dashed var(--border-color); background: var(--container-bg);">
            <form method="POST" style="display: flex; gap: 10px;">
                <input type="text" name="content" required placeholder="√âcris un message..." autocomplete="off"
                    style="flex: 1; border-radius: 20px; border: 2px solid var(--border-color); padding: 10px 15px; font-family: 'Fredoka', sans-serif;">
                <button type="submit" class="cute-btn"
                    style="border-radius: 50%; width: 45px; height: 45px; padding: 0; display: flex; justify-content: center; align-items: center; font-size: 1.2rem;">üíå</button>
            </form>
        </div>

        <!-- Auto-scroll to bottom of chat -->
        <script>
            var chatHistory = document.getElementById("chat-history");
            if (chatHistory) {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}